<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <meta name="generator" content="sphinx-4.4.0, furo 2022.03.04"/>
        <title>1.0 AWS Parallel Cluster - pcluster-cmaq documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=935aa2abcc5c1da4283d1dc201fb1f0add16d23a" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=25ceb02ed1c46dc30f2321ff83e92799f69dfdb9" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">pcluster-cmaq  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">pcluster-cmaq  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="aws-parallel-cluster">
<h1>1.0 AWS Parallel Cluster<a class="headerlink" href="#aws-parallel-cluster" title="Permalink to this headline">#</a></h1>
<section id="please-set-up-a-alarm-on-aws">
<h2>1.1 Please set up a alarm on AWS<a class="headerlink" href="#please-set-up-a-alarm-on-aws" title="Permalink to this headline">#</a></h2>
<p>Configure alarm to receive an email alert if you exceed $100 per month (or what ever monthly spending limit you need).
It may be possible to set up daily or weekly spending alarms as well.</p>
</section>
<section id="software-requirements-for-cmaq-on-aws-parallel-cluster-minimum-viable-product">
<h2>1.2 Software Requirements for CMAQ on AWS Parallel Cluster Minimum Viable Product<a class="headerlink" href="#software-requirements-for-cmaq-on-aws-parallel-cluster-minimum-viable-product" title="Permalink to this headline">#</a></h2>
<p>Tier 1: Native OS and associated system libraries, compilers</p>
<ul class="simple">
<li><p>Operating System: Ubuntu2004</p></li>
<li><p>Tcsh shell</p></li>
<li><p>Git</p></li>
<li><p>Compilers (C, C++, and Fortran) - GNU compilers version ≥ 8.3</p></li>
<li><p>MPI (Message Passing Interface) -  OpenMPI ≥ 4.0</p></li>
<li><p>Slurm Scheduler</p></li>
</ul>
<p>Tier 2: additional libraries required for installing CMAQ</p>
<ul class="simple">
<li><p>NetCDF (with C, C++, and Fortran support)</p></li>
<li><p>I/O API</p></li>
<li><p>R Software and packages</p></li>
</ul>
<p>Tier 3: Software distributed thru the CMAS Center</p>
<ul class="simple">
<li><p>CMAQv533</p></li>
<li><p>CMAQv533 Post Processors</p></li>
</ul>
<p>Tier 4: R packages and Scripts</p>
<ul class="simple">
<li><p>R QA Scripts</p></li>
</ul>
<p>Software on Local Computer</p>
<ul class="simple">
<li><p>AWS CLI v3.0 installed in a virtual environment</p></li>
<li><p>pcluster is the primary AWS ParallelCluster CLI command. You use pcluster to launch and manage HPC clusters in the AWS Cloud and to create and manage custom AMI images</p></li>
<li><p>Edit YAML Configuration Files using vi, nedit or other editor (yaml does not accept tabs as spacing)</p></li>
<li><p>Git</p></li>
<li><p>Mac - XQuartz for X11 Display</p></li>
<li><p>Windows - MobaXterm  - to connect to Parallel Cluster IP address</p></li>
</ul>
</section>
<section id="aws-cli-v3-0-aws-region-availability">
<h2>1.3 AWS CLI v3.0 AWS Region Availability<a class="headerlink" href="#aws-cli-v3-0-aws-region-availability" title="Permalink to this headline">#</a></h2>
<p>Note, the scripts in this tutorial use the us-east-1 region, but the scripts can be modified to use any of the supported regions listed in the url below.</p>
<p><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/supported-regions-v3.html">CLI v3 Supported Regions</a></p>
<section id="right-sizing-compute-nodes-for-the-parallel-cluster-configuration">
<h3>Right-sizing Compute Nodes for the Parallel Cluster Configuration<a class="headerlink" href="#right-sizing-compute-nodes-for-the-parallel-cluster-configuration" title="Permalink to this headline">#</a></h3>
<p>The size of hardware depends on the domain size and resolution for  your CMAQ case, and how quickly your turn-around requirements are.
Larger hardware and memory configurations are also required for instrumented versions of CMAQ incuding CMAQ-ISAM and CMAQ-DDM3D.
The Parallel Cluster allows you to run the compute nodes only as long as the job requires, and you can also update the compute nodes as needed for your domain</p>
</section>
</section>
<section id="mvp-parallel-cluster-configuration-for-conus-domain">
<h2>1.4 MVP Parallel Cluster Configuration for CONUS Domain<a class="headerlink" href="#mvp-parallel-cluster-configuration-for-conus-domain" title="Permalink to this headline">#</a></h2>
<p>Recommended configuration of the Parallel Cluster HPC head node and compute nodes to run the CMAQ CONUS benchmark for two days:</p>
<p>Head node:</p>
<ul class="simple">
<li><p>c5n.large</p></li>
</ul>
<p>Compute Node:</p>
<ul class="simple">
<li><p>c5n.18xlarge
with 192 GiB memory, 14 Gbps EBS Bandwidth, and 100 Gbps Network Bandwidth</p></li>
</ul>
<p>Figure 1. AWS Recommended Parallel Cluster Configuration (Number of compute nodes depends on setting for NPCOLxNPROW and #SBATCH –nodes=XX #SBATCH –ntasks-per-node=YY )</p>
<p><img alt="AWS Minimum Viable Product Configuration" src="../_images/aws_minimum_viable_product.png"/></p>
</section>
<section id="slurm-compute-node-provisioning">
<h2>1.5 Slurm Compute Node Provisioning<a class="headerlink" href="#slurm-compute-node-provisioning" title="Permalink to this headline">#</a></h2>
<p>AWS ParallelCluster doesn’t make job allocation or scaling decisions. It simple tries to launch, terminate, and maintain resources according to Slurm’s instructions.</p>
<p>Number of compute nodes dispatched by the slurm scheduler is specified in the run script using #SBATCH –nodes=XX #SBATCH –ntasks-per-node=YY where the maximum value of tasks per node or YY limited by many CPUs are on the compute node.</p>
<p>For c5n.18xlarge, there are 36 CPUs, so maximum value of YY is 36 or –ntask-per-node=36.</p>
<p>If running a job with 180 processors, this would require the –nodes=XX or XX to be set to 5 compute nodes, as 36x5=180.</p>
<p>The setting for NPCOLxNPROW must also be a maximum of 180, ie. 18 x 10 or 10 x 18 to use all of the CPUs in the parallel cluster.</p>
<p><a href="https://aws.amazon.com/blogs/aws/new-c5n-instances-with-100-gbps-networking/">C5n Instance </a></p>
<p>Each vCPU is a hardware hyperthread on the Intel Xeon Platinum 8000 series processor. You get full control over the C-states on the two largest sizes, allowing you to run a single core at up to 3.5 Ghz using Intel Turbo Boost Technology.</p>
<p>The new instances also feature a higher amount of memory per core, putting them in the current “sweet spot” for HPC applications that work most efficiently when there’s at least 4 GiB of memory for each core. The instances also benefit from some internal improvements that boost memory access speed by up to 19% in comparison to the C5 and C5d instances.</p>
<p>The C5n instances incorporate the fourth generation of our custom Nitro hardware, allowing the high-end instances to provide up to 100 Gbps of network throughput, along with a higher ceiling on packets per second. The Elastic Network Interface (ENI) on the C5n uses up to 32 queues (in comparison to 8 on the C5 and C5d), allowing the packet processing workload to be better distributed across all available vCPUs.</p>
<p>Resources specified in the YAML file for the MVP:</p>
<ul class="simple">
<li><p>Ubuntu2004</p></li>
<li><p>Disable Simultaneous Multi-threading</p></li>
<li><p>Spot Pricing</p></li>
<li><p>Shared EBS filesystem to insall software</p></li>
<li><p>1.2 TiB Shared Lustre file system with imported S3 Bucket (1.2 TiB is the minimum file size that you can specify for Lustre File System)</p></li>
<li><p>Slurm Placement Group enabled</p></li>
<li><p>Elastic Fabric Adapter Enabled on c5n.18xlarge</p></li>
</ul>
<p>Note, pricing information in the tables below are subject to change. The links from which this pricing data was collected are listed below.</p>
<p><a href="https://aws.amazon.com/blogs/aws/new-c5n-instances-with-100-gbps-networking/">AWS c5n Pricing</a></p>
<p><a href="https://aws.amazon.com/ec2/spot/pricing/">EC2 SPOT Pricing</a></p>
<p><a href="https://aws.amazon.com/ec2/pricing/on-demand">EC2 On-Demand Pricing</a></p>
<p><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/spot.html">Working with Spot Instances - Parallel Cluster</a></p>
<p>Table 1. EC2 Instance On-Demand versus Spot Pricing (price is subject to change)</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Instance Name</p></th>
<th class="head"><p>vCPUs</p></th>
<th class="head"><p>RAM</p></th>
<th class="head"><p>EBS Bandwidth</p></th>
<th class="head"><p>Network Bandwidth</p></th>
<th class="head"><p>Linux On-Demand Price</p></th>
<th class="head"><p>Linux Spot Price</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>c4.large</p></td>
<td><p>2</p></td>
<td><p>3.75 GiB</p></td>
<td><p>Moderate</p></td>
<td><p>500 Mbps</p></td>
<td><p>$0.116/hour</p></td>
<td><p>$0.0312/hour</p></td>
</tr>
<tr class="row-odd"><td><p>c4.8xlarge</p></td>
<td><p>36</p></td>
<td><p>60 GiB</p></td>
<td><p>10 Gbps</p></td>
<td><p>4,000 Mbps</p></td>
<td><p>$1.856/hour</p></td>
<td><p>$0.5903/hour</p></td>
</tr>
<tr class="row-even"><td><p>c5n.large</p></td>
<td><p>2</p></td>
<td><p>5.25 GiB</p></td>
<td><p>Up to 3.5 Gbps</p></td>
<td><p>Up to 25 Gbps</p></td>
<td><p>$0.108/hour</p></td>
<td><p>$0.0324/hour</p></td>
</tr>
<tr class="row-odd"><td><p>c5n.xlarge</p></td>
<td><p>4</p></td>
<td><p>10.5 GiB</p></td>
<td><p>Up to 3.5 Gbps</p></td>
<td><p>Up to 25 Gbps</p></td>
<td><p>$0.216/hour</p></td>
<td><p>$0.0648/hour</p></td>
</tr>
<tr class="row-even"><td><p>c5n.2xlarge</p></td>
<td><p>8</p></td>
<td><p>21 GiB</p></td>
<td><p>Up to 3.5 Gbps</p></td>
<td><p>Up to 25 Gbps</p></td>
<td><p>$0.432/hour</p></td>
<td><p>$0.1740/hour</p></td>
</tr>
<tr class="row-odd"><td><p>c5n.4xlarge</p></td>
<td><p>16</p></td>
<td><p>42 GiB</p></td>
<td><p>3.5 Gbps</p></td>
<td><p>Up to 25 Gbps</p></td>
<td><p>$0.864/hour</p></td>
<td><p>$0.2860/hour</p></td>
</tr>
<tr class="row-even"><td><p>c5n.9xlarge</p></td>
<td><p>36</p></td>
<td><p>96 GiB</p></td>
<td><p>7 Gbps</p></td>
<td><p>50 Gbps</p></td>
<td><p>$1.944/hour</p></td>
<td><p>$0.5971/hour</p></td>
</tr>
<tr class="row-odd"><td><p>c5n.18xlarge</p></td>
<td><p>72</p></td>
<td><p>192 GiB</p></td>
<td><p>14 Gbps</p></td>
<td><p>100 Gbps</p></td>
<td><p>$3.888/hour</p></td>
<td><p>$1.1732/hour</p></td>
</tr>
</tbody>
</table></div>
<p>Using c5n.18xlarge as the compute node, it costs (3.888/hr)/(1.1732/hr) = 3.314 times as much to run on demand versus spot pricing.</p>
</section>
<section id="benchmark-timing-results">
<h2>1.6 Benchmark Timing Results<a class="headerlink" href="#benchmark-timing-results" title="Permalink to this headline">#</a></h2>
<p>Table 2. Timing Results for CMAQv5.3.3 2 Day CONUS2 Run on Parallel Cluster with c5n.large head node and C5n.18xlarge Compute Nodes</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Number of PEs</p></th>
<th class="head"><p>#Nodesx#CPU</p></th>
<th class="head"><p>NPCOLxNPROW</p></th>
<th class="head"><p>Day1 Timing (sec)</p></th>
<th class="head"><p>Day2 Timing (sec)</p></th>
<th class="head"><p>Total Time(2days)(sec)</p></th>
<th class="head"><p>SBATCH –exclusive</p></th>
<th class="head"><p>Data Imported or Copied</p></th>
<th class="head"><p>DisableSimultaneousMultithreading(yaml)</p></th>
<th class="head"><p>with -march=native</p></th>
<th class="head"><p>Answers Matched</p></th>
<th class="head"><p>Cost using Spot Pricing</p></th>
<th class="head"><p>Cost using On Demand Pricing</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>36</p></td>
<td><p>1x36</p></td>
<td><p>6x6</p></td>
<td><p>6726.72</p></td>
<td><p>5821.47</p></td>
<td><p>12548.19</p></td>
<td><p>yes</p></td>
<td><p>imported</p></td>
<td><p>true</p></td>
<td><p>yes</p></td>
<td><p></p></td>
<td><p>1.1732/hr * 1 node * 3.486 hr= $4.09</p></td>
<td><p>3.888/hr * 1 node * 3.496 hr = $13.59</p></td>
</tr>
<tr class="row-odd"><td><p>72</p></td>
<td><p>2x36</p></td>
<td><p>6x12</p></td>
<td><p>3562.50</p></td>
<td><p>3151.21</p></td>
<td><p>6713.71</p></td>
<td><p>yes</p></td>
<td><p>imported</p></td>
<td><p>true</p></td>
<td><p>yes</p></td>
<td><p>6x12 did not match 12x9</p></td>
<td><p>1.1732/hr * 2 nodes * 1.8649 hr = $4.37</p></td>
<td><p>3.888/hr * 2 nodes * 1.8649 = $14.5</p></td>
</tr>
<tr class="row-even"><td><p>72</p></td>
<td><p>2x36</p></td>
<td><p>8x9</p></td>
<td><p>3665.65</p></td>
<td><p>3159.12</p></td>
<td><p>6824.77</p></td>
<td><p>yes</p></td>
<td><p>imported</p></td>
<td><p>true</p></td>
<td><p>yes</p></td>
<td><p></p></td>
<td><p>1.1732/hr * 2 nodes * 1.8649 hr = $4.37</p></td>
<td><p>3.888/hr * 2 nodes * 1.8649 = $14.5</p></td>
</tr>
<tr class="row-odd"><td><p>72</p></td>
<td><p>2x36</p></td>
<td><p>9x8</p></td>
<td><p>3562.61</p></td>
<td><p>2999.69</p></td>
<td><p>6562.30</p></td>
<td><p>yes</p></td>
<td><p>imported</p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
</tbody>
</table></div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>      |  true              | yes                   |                          | 1.1732/hr * 2 nodes * 1.8649 hr = $4.37 | 3.888/hr * 2 nodes * 1.8649 = $14.5  |
</pre></div>
</div>
<p>| 108           |  3x36          | 6x18          | 2415.46 | 2135.26   | 4550.72               |  yes                | imported                | true                   |   yes  | 6x12 does match 6x18   |     1.1732/hr * 3 nodes * 1.26 hr = $4.45           |   3.888/hr * 3 nodes * 1.26  = $14.7  |
| 108           | 3x36           | 12x9          | 2758.01 | 2370.92   | 5128.93               |  yes                | imported                | true         |  yes |  6x12 did not match 12x9 |   1.1732/hr * 3 nodes * 1.42 hr = $5.01    |   3.888/hr * 3 nodes * 1.42 hr = $16.6                                    |
| 180           |  5x36          | 10x18         | 2481.55              | 2225.34              |    4706.89                 |  no               | copied                  |  false           | yes              |            | 1.1732/hr * 5 nodes * 1.307 hr = $7.66 | 3.888/hr * 5 nodes * 1.307 hr = $25.4 |
| 180           |  5x36          | 10x18         | 2378.73              | 2378.73              |    4588.92                 |  no                | copied                  |  true        | yes       | 10x18 did not match 16x18 | 1.1732/hr * 5 nodes * 1.2747 = $7.477 | $ 24.77 |
| 180           |  5x36          | 10x18         | 1585.67        | 1394.52         |    2980.19           |  yes                | imported    |  true        |   yes |          | 1.1732/hr * 5nodes * 2980.9 / 3600 = $4.85 | $16.05 |
| 256           |  8x32          | 16x16         |  1289.59       | 1164.53         |    2454.12           |  no                 |  copied           |  true    | yes |            | 1.1732/hr * 8nodes * 2454.12 / 3600 = $6.398  | $21.66 |
| 256           |  8x32          | 16x16         |  1305.99       | 1165.30         |    2471.29           |  no                |   copied    |   true    |  yes |           | 1.1732/hr * 8nodes * 2471.29 / 3600 = $6.44 | $21.11 |
| 256           |  8x32          | 16x16         |  1564.90       | 1381.80         |    2946.70           |  no                |   imported  | true   |   yes |         | 1.1732/hr * 8nodes * 2946.7 / 3600 = $7.68 | $25.55 |
| 288           |  8x36          | 16x18         | 1873.00        | 1699.24         |     3572.2           |  no                |  copied     |    false | yes |            | 1.1732/hr * 8nodes * 3572.2/3600= $9.313  | $30.8 |
| 288           |  8x36          |  16x18        |  1976.35       | 1871.61         |     3847.96          |  no                |  copied     |  true   | yes |            | 1.1732/hr * 8nodes * 3847.96=$10.0 | $33.18 |
| 288           |  8x36          | 16x18         |  1197.19       | 1090.45         |     2287.64          |  yes               |  copied     |  true   | yes |             16x18 matched 16x16 | 1.1732/hr * 8nodes * 2297.64=$5.99 | $19.81
| 288           |  8x36          | 18x16         | 1206.01        | 1095.76         |     2301.77          |  yes               |  imported   |  true        |             |   | 1.1732/hr * 8nodes * 2301.77=$6.00 | $19.46 |
| 360           | 10x36          | 18x20         |   unable to provision  |                 |                      |                    |  imported   |  true        |    yes         |       |        |</p>
<p>Example screenshots of the AWS Cost Explorer Graphs were obtained after running several of the CMAQ Benchmarks, varying # nodes and # cpus and NPCOL/NPROW.  These costs are of a two day session of running CMAQ on the Parallel Cluster, and should only be used to understand the relative cost of the EC2 instances (head node and compute nodes), compared to the storage, and network costs.</p>
<p>In Figure 2 The Cost Explorer Display shows the cost of different EC2 Instance Types: note that c5n.18xlarge is highest cost - as these are used as the compute nodes</p>
<p>Figure 2. Cost by Instance Type - AWS Console</p>
<p><img alt="AWS Cost Management Console - Cost by Instance Type" src="../_images/AWS_Bench_Cost.png"/></p>
<p>In Figure 3 The Cost Explorer displays a graph of the cost categorized by usage by spot or OnDemand, NatGateway, or Timed Storage. Note: spot-c5n.18xlarge is highest generating cost resource, but other resources such as storage on the EBS volume and the network NatGatway or SubnetIDs also incur costs</p>
<p>Figure 3. Cost by Usage Type - AWS Console</p>
<p><img alt="AWS Cost Management Console - Cost by Usage Type" src="../_images/AWS_Bench_Usage_Type_Cost.png"/></p>
<p>In Figure 4 The Cost Explorer Display shows the cost by Services including EC2 Instances, S3 Buckets, and FSx Lustre File Systems</p>
<p>Figure 4. Cost by Service Type - AWS Console</p>
<p><img alt="AWS Cost Management Console - Cost by Service Type" src="../_images/AWS_Bench_Service_Type_Cost.png"/></p>
</section>
<section id="compute-node-cost-estimate">
<h2>1.7 Compute Node Cost Estimate<a class="headerlink" href="#compute-node-cost-estimate" title="Permalink to this headline">#</a></h2>
<p>Head node c5n.large compute cost = entire time that the parallel cluster is running ( creation to deletion) = 6 hours * $0.0324/hr = $ .1944 using spot pricing, 6 hours * $.108/hr = $.648 using on demand pricing.</p>
<p>Total c5n.18xlarge cost of Running Benchmarking Suite using ONDEMAND pricing = $297
(sum the cost of all of the runs in the above table assuming ONDEMAND pricing)</p>
<p>Total c5n.18xlarge cost of Running Benchmarking Suite using SPOT pricing = $89</p>
<p>Using 288 cpus on the Parallel Cluster, it would take ~4.832 days to run a full year, using 8 c5n.18xlarge compute nodes.</p>
<p>Table 3. Extrapolated Cost of c5n.18xlarge used for CMAQv5.3.3 Annual Simulation based on 2 day CONUS benchmark</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Benchmark Case</p></th>
<th class="head"><p>Number of PES</p></th>
<th class="head"><p>Number of c5n.18xlarge Nodes</p></th>
<th class="head"><p>Pricing</p></th>
<th class="head"><p>Cost per node</p></th>
<th class="head"><p>Time to completion (hour)</p></th>
<th class="head"><p>Extrapolate Cost for Annual Simulation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2 day CONUS</p></td>
<td><p>288</p></td>
<td><p>8</p></td>
<td><p>SPOT</p></td>
<td><p>1.1732/hour</p></td>
<td><p>2287.64/3600 = .635455</p></td>
<td><p>.635455/2 * 365 = 115.97 hours/node * 8 nodes = 927.7 * $1.1732 = $1088.4</p></td>
</tr>
<tr class="row-odd"><td><p>2 day CONUS</p></td>
<td><p>288</p></td>
<td><p>8</p></td>
<td><p>ONDEMAND</p></td>
<td><p>3.888/hour</p></td>
<td><p>2287.64/3600 = .635455</p></td>
<td><p>.635455/2 * 365 = 115.97 hours/node * 8 nodes = 927.7 * $3.888 = $3606.9</p></td>
</tr>
</tbody>
</table></div>
<p><a href="https://aws.amazon.com/fsx/lustre/pricing/">AWS Lustre Pricing</a></p>
<p>Table 4. Lustre SSD File System Pricing for us-east-1 region</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Storage Type</p></th>
<th class="head"><p>Storage options</p></th>
<th class="head"><p>Pricing with data compression enabled*</p></th>
<th class="head"><p>Pricing (monthly)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Persistent</p></td>
<td><p>125 MB/s/TB</p></td>
<td><p>$0.073</p></td>
<td><p>$0.145/month</p></td>
</tr>
<tr class="row-odd"><td><p>Persistent</p></td>
<td><p>250 MB/s/TB</p></td>
<td><p>$0.105</p></td>
<td><p>$0.210/month</p></td>
</tr>
<tr class="row-even"><td><p>Persistent</p></td>
<td><p>500 MB/s/TB</p></td>
<td><p>$0.170</p></td>
<td><p>$0.340/month</p></td>
</tr>
<tr class="row-odd"><td><p>Persistent</p></td>
<td><p>1,000 MB/s/TB</p></td>
<td><p>$0.300</p></td>
<td><p>$0.600/month</p></td>
</tr>
<tr class="row-even"><td><p>Scratch</p></td>
<td><p>200/MB/s/TiB</p></td>
<td><p>$0.070</p></td>
<td><p>$0.140/month</p></td>
</tr>
</tbody>
</table></div>
<p>Note, there is a difference in the storage sizing units that were obtained from AWS.
See the following article for additional information:
<a href="https://www.techtarget.com/searchstorage/definition/tebibyte-TiB#:~:text=Tebibyte%20vs.&amp;text=One%20tebibyte%20is%20equal%20to,when%20talking%20about%20storage%20capacity">TB vs TiB</a></p>
<p>One tebibyte is equal to 240 or 1,099,511,627,776 bytes.
One terabyte is equal to 1012 or 1,000,000,000,000 bytes.
A tebibyte equals nearly 1.1 TB.
That’s about a 10% difference between the size of a tebibyte and a terabyte, which is significant when talking about storage capacity.</p>
<p>Lustre Scratch SSD 200 MB/s/TiB is tier of the storage pricing that we have configured in the yaml for the cmaq parallel cluster.</p>
<p><a href="https://docs.aws.amazon.com/parallelcluster/latest/ug/SharedStorage-v3.html#SharedStorage-v3-FsxLustreSettings">YAML FSxLustreSettings</a></p>
<p>Cost example:
0.14 USD per month / 730 hours in a month = 0.00019178 USD per hour</p>
<p>Note: 1.2 TiB is the minimum file size that you can specify for the lustre file system</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1,200 GiB x 0.00019178 USD per hour x 24 hours x 5 days = 27.6 USD
</pre></div>
</div>
<p>Question is 1.2 TiB enough for the output of a yearly CMAQ run?</p>
<p>For the output data, assuming 2 day CONUS Run, all 35 layers, all 244 variables in CONC output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">fsx</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">output_CCTM_v532_gcc_2016_CONUS_16x8pe_full</span>
<span class="n">du</span> <span class="o">-</span><span class="n">sh</span>
</pre></div>
</div>
<p>Size of output directory when CMAQ is run to output all 35 layers, all 244 variables in the CONC file, includes all other output files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">173</span><span class="n">G</span> <span class="o">.</span>
</pre></div>
</div>
<p>So we need 86.5 GB per day</p>
<p>Storage requirement for an annual simulation if you assumed you would keep all data on lustre filesystem</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> 86.5 GB * 365 days = 31,572.5 GB  = 31.5 TB
</pre></div>
</div>
</section>
<section id="annual-simulation-local-storage-cost-estimate">
<h2>1.8 Annual simulation local storage cost estimate<a class="headerlink" href="#annual-simulation-local-storage-cost-estimate" title="Permalink to this headline">#</a></h2>
<p>Assuming it takes 5 days to complete the annual simulation, and after the annual simulation is completed, the data is moved to archive storage.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> 31,572.5 GB x 0.00019178 USD per hour x 24 hours x 5 days = $726.5 USD
</pre></div>
</div>
<p>To reduce storage requirements; after the CMAQ run is completed for each month, the post-processing scripts are run and completed, and then the CMAQ Output data for that month is moved from the Lustre Filesystem to the Archived Storage. Monthly data volume storage requirements to store 1 month of data on the lustre file system is approximately 86.5 x 30 days = 2,595 GB or 2.6 TB.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  2,595 GB x 0.00019178 USD per hour x 24 hours x 5 days = $60 USD
</pre></div>
</div>
<p>Estimate for S3 Bucket cost for storing an annual simulation</p>
<p><a href="https://aws.amazon.com/s3/pricing/?p=pm&amp;c=s3&amp;z=4">S3 Storage Pricing Tiers</a></p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>S3 Standard - General purpose storage</p></th>
<th class="head"><p>Storage Pricing</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>First 50 TB / Month</p></td>
<td><p>$0.023 per GB</p></td>
</tr>
<tr class="row-odd"><td><p>Next 450 TB / Month</p></td>
<td><p>$0.022 per GB</p></td>
</tr>
<tr class="row-even"><td><p>Over 500 TB / Month</p></td>
<td><p>$0.021 per GB</p></td>
</tr>
</tbody>
</table></div>
</section>
<section id="archive-storage-cost-estimate-for-annual-simulation-assuming-you-want-to-save-it-for-1-year">
<h2>1.9 Archive Storage cost estimate for annual simulation - assuming you want to save it for 1 year<a class="headerlink" href="#archive-storage-cost-estimate-for-annual-simulation-assuming-you-want-to-save-it-for-1-year" title="Permalink to this headline">#</a></h2>
<p>31.5 TB * 1024 GB/TB * .023 per GB * 12 months  = $8,903</p>
<div class="table-wrapper"><table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>S3 Glacier Flexible Retrieval (Formerly S3 Glacier)</p></th>
<th class="head"><p>Storage Pricing</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>long-term archives with retrieval option from 1 minute to 12 hours</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>All Storage / Month</p></td>
<td><p>$0.0036 per GB</p></td>
</tr>
</tbody>
</table></div>
<p>S3 Glacier Flexible Retrieval Costs 6.4 times less than the S3 Standard</p>
<p>31.5 TB * 1024 GB/TB * $.0036 per GB * 12 months  = $1393.0 USD</p>
<p>Lower cost option is S3 Glacier Deep Archive (accessed once or twice a year, and restored in 12 hours)</p>
<p>31.5 TB * 1024 GB/TB * $.00099 per GB * 12 months  = $383 USD</p>
</section>
<section id="recommended-workflow-for-extending-to-annual-run">
<h2>1.10 Recommended Workflow for extending to annual run<a class="headerlink" href="#recommended-workflow-for-extending-to-annual-run" title="Permalink to this headline">#</a></h2>
<p>Post-process monthly save output and/or post-processed outputs to S3 Bucket at the end of each month.</p>
<p>Still need to determine size of post-processed output (combine output, etc).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  86.5 GB * 31 days = 2,681.5 GB * 1 TB/1024 GB =  2.62 TB
</pre></div>
</div>
<p>Cost for lustre storage of a monthly simulation</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  2,681.5 GB x 0.00019178 USD per hour x 24 hours x 5 days = $61.7 USD
</pre></div>
</div>
<p>Goal is to develop a reproducable workflow that does the post processing after every month, and then copies what is required to the S3 Bucket, so that only 1 month of output is imported at a time to the lustre scratch file system from the S3 bucket.
This workflow will help with preserving the data in case the cluster or scratch file system gets pre-empted.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Liz Adams
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">1.0 AWS Parallel Cluster</a><ul>
<li><a class="reference internal" href="#please-set-up-a-alarm-on-aws">1.1 Please set up a alarm on AWS</a></li>
<li><a class="reference internal" href="#software-requirements-for-cmaq-on-aws-parallel-cluster-minimum-viable-product">1.2 Software Requirements for CMAQ on AWS Parallel Cluster Minimum Viable Product</a></li>
<li><a class="reference internal" href="#aws-cli-v3-0-aws-region-availability">1.3 AWS CLI v3.0 AWS Region Availability</a><ul>
<li><a class="reference internal" href="#right-sizing-compute-nodes-for-the-parallel-cluster-configuration">Right-sizing Compute Nodes for the Parallel Cluster Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mvp-parallel-cluster-configuration-for-conus-domain">1.4 MVP Parallel Cluster Configuration for CONUS Domain</a></li>
<li><a class="reference internal" href="#slurm-compute-node-provisioning">1.5 Slurm Compute Node Provisioning</a></li>
<li><a class="reference internal" href="#benchmark-timing-results">1.6 Benchmark Timing Results</a></li>
<li><a class="reference internal" href="#compute-node-cost-estimate">1.7 Compute Node Cost Estimate</a></li>
<li><a class="reference internal" href="#annual-simulation-local-storage-cost-estimate">1.8 Annual simulation local storage cost estimate</a></li>
<li><a class="reference internal" href="#archive-storage-cost-estimate-for-annual-simulation-assuming-you-want-to-save-it-for-1-year">1.9 Archive Storage cost estimate for annual simulation - assuming you want to save it for 1 year</a></li>
<li><a class="reference internal" href="#recommended-workflow-for-extending-to-annual-run">1.10 Recommended Workflow for extending to annual run</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>